<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <title>高德地图路径规划 - 支持往返路线</title>
    <style>
        /* CSS from previous version - no changes */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
            overflow: hidden;
        }
        #container { width: 100%; height: 100%; }
        #control-panel {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15); max-width: 350px;
            max-height: calc(100% - 20px); overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        .list-panel { max-height: 120px; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; border-radius: 3px; }
        .list-item { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background-color: #f0f8ff; }
        .list-item.selected { background-color: #fffbe6; font-weight: bold; }
        input, button, select { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        #get-location-btn { background-color: #17a2b8; }
        #get-location-btn:hover { background-color: #138496; }
        #clear-btn { background-color: #dc3545; }
        #clear-btn:hover { background-color: #c82333; }
        #optimize-btn { background-color: #28a745; }
        #optimize-btn:hover { background-color: #218838; }
        #import-csv-btn { background-color: #ffc107; color: black; }
        #import-csv-btn:hover { background-color: #e0a800; }
        .error-message { color: #dc3545; font-size: 14px; margin-top: 5px; }
        .delete-btn { background-color: #6c757d; color: white; padding: 2px 6px; font-size: 12px; margin-left: 10px; width: auto; }
        .delete-btn:hover { background-color: #5a6268; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .control-group:last-of-type { border-bottom: none; }
        .manual-add-input { margin-bottom: 5px; }
        #route-info-panel { display: none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; }
        #route-info-panel p { margin: 5px 0; }
        #menu-toggle { display: none; position: absolute; top: 15px; left: 15px; z-index: 101; width: 30px; height: 30px; background: white; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #menu-toggle span { display: block; width: 20px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s; }
        input[type="file"] { display: none; }
        @media (max-width: 768px) { #menu-toggle { display: flex; } #control-panel { width: 85%; max-width: 320px; } #control-panel.collapsed { transform: translateX(-110%); } }
    </style>
</head>
<body>
    <!-- HTML from previous version - no changes -->
    <div id="container"></div>
    <div id="menu-toggle"><span></span><span></span><span></span></div>
    <div id="control-panel" class="collapsed">
        <div class="control-group">
            <h3>地图设置</h3>
            <select id="map-type-selector">
                <option value="standard">标准地图</option>
                <option value="satellite">卫星地图</option>
            </select>
            <button id="goto-location-btn" title="跳转到我的位置">跳转至我的位置</button>
        </div>
        <div class="control-group">
            <h3>数据点管理</h3>
            <input type="file" id="csv-input" accept=".csv">
            <button id="import-csv-btn">导入CSV文件</button>
            <button id="get-location-btn" style="margin-top:10px;">添加当前位置为起点</button>
            <div style="margin-top:15px; padding-top:10px; border-top: 1px solid #eee;">
                <input type="text" id="manual-id-input" placeholder="输入点ID (例如: A01)" class="manual-add-input">
                <input type="text" id="manual-lng-input" placeholder="输入经度 (例如: 116.405)" class="manual-add-input">
                <input type="text" id="manual-lat-input" placeholder="输入纬度 (例如: 39.904)" class="manual-add-input">
                <button id="manual-add-btn">手动添加点</button>
            </div>
            <div class="list-panel" id="imported-points-list">
                <h4>数据源 (点击以添加至规划)</h4>
                <div id="imported-points-container"></div>
            </div>
        </div>
        <div class="control-group">
            <h3>路径规划</h3>
            <div class="list-panel" id="planning-waypoints-list">
                <h4>规划列表 (起点->途经点->终点)</h4>
                <div id="planning-waypoints-container"></div>
            </div>
            <select id="strategy-selector">
                <option value="LEAST_TIME">时间最短</option>
                <option value="LEAST_DISTANCE">距离最短</option>
                <option value="LEAST_FEE">费用最少</option>
                <option value="AVOID_HIGHWAY">不走高速</option>
            </select>
            <button id="optimize-btn">开始顺路规划</button>
        </div>
        <div id="route-info-panel">
            <p><strong>预计时间：</strong><span id="route-time">--</span></p>
            <p><strong>总路程：</strong><span id="route-distance">--</span></p>
        </div>
        <button id="clear-btn" style="margin-top: 15px;">清空所有</button>
        <div id="error-message" class="error-message"></div>
    </div>

    <script type="text/javascript">
        window._AMapSecurityConfig = { securityJsCode: '18f3474d5a34085469b83c202da831ef' };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=02cd41675942a0db9428d859a0e6f4f3&plugin=AMap.Driving,AMap.Geolocation,AMap.TileLayer"></script>
    
    <script type="text/javascript">
        // --- Setup and DOM element acquisition - no changes ---
        var map = new AMap.Map('container', { zoom: 11, center: [116.397428, 39.90923] });
        var importedPoints = [], planningWaypoints = [];
        var driving = null, geolocation = null;
        var satelliteLayer = new AMap.TileLayer.Satellite(), roadNetLayer = new AMap.TileLayer.RoadNet();
        var controlPanel = document.getElementById('control-panel'), menuToggle = document.getElementById('menu-toggle');
        var optimizeBtn = document.getElementById('optimize-btn'), clearBtn = document.getElementById('clear-btn');
        var errorMessage = document.getElementById('error-message');
        var strategySelector = document.getElementById('strategy-selector');
        var routeInfoPanel = document.getElementById('route-info-panel'), routeTimeEl = document.getElementById('route-time'), routeDistanceEl = document.getElementById('route-distance');
        var importCsvBtn = document.getElementById('import-csv-btn'), csvInput = document.getElementById('csv-input');
        var mapTypeSelector = document.getElementById('map-type-selector'), gotoLocationBtn = document.getElementById('goto-location-btn');
        var getLocationBtn = document.getElementById('get-location-btn');
        var manualIdInput = document.getElementById('manual-id-input'), manualLngInput = document.getElementById('manual-lng-input'), manualLatInput = document.getElementById('manual-lat-input'), manualAddBtn = document.getElementById('manual-add-btn');
        var importedPointsContainer = document.getElementById('imported-points-container');
        var planningWaypointsContainer = document.getElementById('planning-waypoints-container');
        var defaultIcon = new AMap.Icon({ size: new AMap.Size(25, 34), image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png', imageSize: new AMap.Size(25, 34) });
        var selectedIcon = new AMap.Icon({ size: new AMap.Size(25, 34), image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png', imageSize: new AMap.Size(25, 34) });

        // --- Event binding - no changes ---
        menuToggle.addEventListener('click', (e) => { e.stopPropagation(); controlPanel.classList.toggle('collapsed'); });
        map.on('click', () => { if (!controlPanel.classList.contains('collapsed')) { controlPanel.classList.add('collapsed'); } });
        controlPanel.addEventListener('click', (e) => e.stopPropagation());
        optimizeBtn.addEventListener('click', doPathOptimize);
        clearBtn.addEventListener('click', clearAll);
        importCsvBtn.addEventListener('click', () => csvInput.click());
        csvInput.addEventListener('change', handleFileSelect);
        manualAddBtn.addEventListener('click', handleManualAdd);
        mapTypeSelector.addEventListener('change', changeMapType);
        gotoLocationBtn.addEventListener('click', gotoCurrentLocation);
        getLocationBtn.addEventListener('click', getLocationAsStart);
        if (window.innerWidth > 768) { controlPanel.classList.remove('collapsed'); }
        
        // --- Main Functions (LOGIC HAS BEEN UPDATED) ---

        /**
         * Adds a point to the main data source list.
         * This function handles marker creation, list item creation, and event binding.
         */
        function addPointToDataSource(pointData) {
            if (importedPoints.some(p => p.id === pointData.id)) {
                showErrorMessage('添加失败：ID "' + pointData.id + '" 已存在。');
                return null;
            }
            const point = { ...pointData, marker: null, listItem: null };
            point.marker = new AMap.Marker({
                position: [point.lng, point.lat], icon: defaultIcon,
                label: { content: String(point.id), direction: 'bottom' },
                extData: { id: point.id }
            });
            point.marker.on('click', () => addPointToPlan(point));
            map.add(point.marker);
            point.listItem = document.createElement('div');
            point.listItem.className = 'list-item';
            point.listItem.textContent = 'ID: ' + point.id;
            point.listItem.onclick = () => addPointToPlan(point);
            importedPointsContainer.appendChild(point.listItem);
            importedPoints.push(point);
            return point;
        }

        /**
         * 【NEW】Adds a point to the planning list.
         * Allows the same point to be added multiple times.
         */
        function addPointToPlan(point) {
            planningWaypoints.push(point);
            point.marker.setIcon(selectedIcon);
            point.listItem.classList.add('selected');
            updatePlanningList();
        }

        /**
         * 【NEW】Removes a point from the planning list at a specific index.
         * Handles updating the visual state of the point in the data source.
         */
        function removePointFromPlan(index) {
            const pointToRemove = planningWaypoints[index];
            planningWaypoints.splice(index, 1);
            
            // Check if this point still exists elsewhere in the planning list
            const stillExists = planningWaypoints.some(p => p.id === pointToRemove.id);
            
            // If it no longer exists in the plan, reset its style
            if (!stillExists) {
                pointToRemove.marker.setIcon(defaultIcon);
                pointToRemove.listItem.classList.remove('selected');
            }
            
            updatePlanningList();
        }

        /**
         * Renders the list of points selected for planning.
         * The 'remove' button now calls the new removePointFromPlan function.
         */
        function updatePlanningList() {
            planningWaypointsContainer.innerHTML = '';
            planningWaypoints.forEach((point, index) => {
                var item = document.createElement('div');
                item.className = 'list-item';
                var label = (index === 0) ? '起点: ' : (index === planningWaypoints.length - 1) ? '终点: ' : '途经: ';
                item.textContent = label + 'ID ' + point.id;
                
                var deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '移除';
                // CRITICAL CHANGE: Calls removePointFromPlan with the specific index
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removePointFromPlan(index);
                };
                item.appendChild(deleteBtn);
                planningWaypointsContainer.appendChild(item);
            });
            // If a route is showing, clear it because the plan has changed
            if (driving) {
                driving.clear();
                routeInfoPanel.style.display = 'none';
            }
        }

        function handleFileSelect(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = (e) => {
                try { parseCsvAndAddPoints(e.target.result); } 
                catch (err) { showErrorMessage('解析文件失败：' + err.message); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCsvAndAddPoints(csvText) {
            var lines = csvText.trim().split(/\r\n|\n/);
            var pointsAddedCount = 0;
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                var parts = line.split(',');
                if (parts.length < 3) continue;
                var id = parts[0].trim();
                var lng = parseFloat(parts[1]);
                var lat = parseFloat(parts[2]);
                if (!id || isNaN(lng) || isNaN(lat)) continue;
                if(addPointToDataSource({ id, lng, lat })) {
                    pointsAddedCount++;
                }
            }
            if (pointsAddedCount > 0) {
                map.setFitView();
                showErrorMessage('成功导入 ' + pointsAddedCount + ' 个点！');
            } else {
                showErrorMessage('CSV文件中未找到有效坐标点');
            }
        }

        function handleManualAdd() {
            var id = manualIdInput.value.trim();
            var lng = parseFloat(manualLngInput.value);
            var lat = parseFloat(manualLatInput.value);
            if (!id) { showErrorMessage('ID不能为空'); return; }
            if (isNaN(lng) || isNaN(lat)) { showErrorMessage('经纬度必须为有效数字'); return; }
            if (addPointToDataSource({ id, lng, lat })) {
                showErrorMessage('成功添加点: ' + id);
                manualIdInput.value = ''; manualLngInput.value = ''; manualLatInput.value = '';
                map.setFitView();
            }
        }

        function getLocationAsStart() {
            getLocationBtn.disabled = true;
            getLocationBtn.textContent = '正在定位...';
            var geoloc = new AMap.Geolocation({ timeout: 10000 });
            geoloc.getCurrentPosition((status, result) => {
                if (status === 'complete') {
                    let counter = 1;
                    let id = `MyLocation-${counter}`;
                    while(importedPoints.some(p => p.id === id)) {
                        counter++;
                        id = `MyLocation-${counter}`;
                    }
                    const newPoint = addPointToDataSource({ id: id, lng: result.position.lng, lat: result.position.lat });
                    if (newPoint) {
                        addPointToPlan(newPoint); // Also add it directly to the plan
                        map.setCenter(result.position);
                        showErrorMessage('已添加当前位置为起点');
                    }
                } else {
                    showErrorMessage('定位失败: ' + result.message);
                }
                getLocationBtn.disabled = false;
                getLocationBtn.textContent = '添加当前位置为起点';
            });
        }

        function doPathOptimize() {
            if (planningWaypoints.length < 2) { showErrorMessage('至少选择2个点进行规划'); return; }
            if (driving) { driving.clear(); }
            routeInfoPanel.style.display = 'none';
            var selectedPolicy = AMap.DrivingPolicy[strategySelector.value];
            driving = new AMap.Driving({ map: map, policy: selectedPolicy, autoFitView: true, extensions: 'all' });
            var startPoint = new AMap.LngLat(planningWaypoints[0].lng, planningWaypoints[0].lat);
            var endPoint = new AMap.LngLat(planningWaypoints[planningWaypoints.length - 1].lng, planningWaypoints[planningWaypoints.length - 1].lat);
            var intermediatePoints = planningWaypoints.slice(1, -1).map(p => new AMap.LngLat(p.lng, p.lat));
            var searchOptions = { viaReordering: true };
            if (intermediatePoints.length > 0) { searchOptions.waypoints = intermediatePoints; }
            driving.search(startPoint, endPoint, searchOptions, (status, result) => {
                if (status === 'complete' && result.routes && result.routes.length) {
                    var route = result.routes[0];
                    routeTimeEl.textContent = formatTime(route.time);
                    routeDistanceEl.textContent = (route.distance / 1000).toFixed(2) + " 公里";
                    routeInfoPanel.style.display = 'block';
                } else {
                    showErrorMessage('路径规划失败: ' + (result.info || '未知错误'));
                }
            });
        }
        
        // --- Utility Functions - no changes ---
        function clearAll() {
            if (driving) { driving.clear(); }
            map.remove(importedPoints.map(p => p.marker));
            importedPoints = [];
            planningWaypoints = [];
            importedPointsContainer.innerHTML = '';
            planningWaypointsContainer.innerHTML = '';
            errorMessage.textContent = '';
            routeInfoPanel.style.display = 'none';
        }
        function changeMapType() {
            if (mapTypeSelector.value === 'satellite') { map.add([satelliteLayer, roadNetLayer]); } 
            else { map.remove([satelliteLayer, roadNetLayer]); }
        }
        function gotoCurrentLocation() {
            var geoloc = new AMap.Geolocation({ enableHighAccuracy: true, timeout: 10000, zoomToAccuracy: true });
            geoloc.getCurrentPosition((status, result) => {
                if (status == 'complete') {
                    map.setCenter(result.position);
                    showErrorMessage('定位成功！');
                } else {
                    showErrorMessage('定位失败：' + result.message);
                }
            });
        }
        function showErrorMessage(message) { errorMessage.textContent = message; setTimeout(() => { errorMessage.textContent = ''; }, 5000); }
        function formatTime(seconds) { if (isNaN(seconds) || seconds < 0) return "--"; var h = Math.floor(seconds / 3600); var m = Math.floor((seconds % 3600) / 60); var res = ""; if (h > 0) res += h + "小时"; if (m > 0 || h === 0) res += m + "分钟"; return res || "小于1分钟"; }
        
        // --- Initialization ---
        updatePlanningList();
    </script>
</body>
</html>
