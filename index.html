<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <title>高德地图路径规划 - 专业版</title>
    <style>
        /* 您的CSS样式，我们只增加一些小样式 */
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; overflow: hidden; }
        #container { width: 100%; height: 100%; }
        #control-panel {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15); max-width: 350px;
            max-height: calc(100% - 20px); overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        .list-panel { max-height: 150px; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; border-radius: 3px; }
        .list-item { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background-color: #f0f8ff; }
        .list-item.selected { background-color: #fffbe6; font-weight: bold; }
        input, button, select { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        #clear-btn { background-color: #dc3545; }
        #clear-btn:hover { background-color: #c82333; }
        #optimize-btn { background-color: #28a745; }
        #optimize-btn:hover { background-color: #218838; }
        #import-csv-btn { background-color: #ffc107; color: black; }
        #import-csv-btn:hover { background-color: #e0a800; }
        .error-message { color: #dc3545; font-size: 14px; margin-top: 5px; }
        .delete-btn { background-color: #6c757d; color: white; padding: 2px 6px; font-size: 12px; margin-left: 10px; width: auto; }
        .delete-btn:hover { background-color: #5a6268; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #route-info-panel { display: none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; }
        #route-info-panel p { margin: 5px 0; }
        #menu-toggle { display: none; position: absolute; top: 15px; left: 15px; z-index: 101; width: 30px; height: 30px; background: white; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #menu-toggle span { display: block; width: 20px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s; }
        input[type="file"] { display: none; }
        @media (max-width: 768px) { #menu-toggle { display: flex; } #control-panel { width: 85%; max-width: 320px; } #control-panel.collapsed { transform: translateX(-110%); } }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="menu-toggle"><span></span><span></span><span></span></div>
    <div id="control-panel" class="collapsed">
        <div class="control-group">
            <h3>数据导入与管理</h3>
            <input type="file" id="csv-input" accept=".csv">
            <button id="import-csv-btn">导入CSV文件</button>
            <div class="list-panel" id="imported-points-list">
                <h4>数据源 (点击以选择)</h4>
                <div id="imported-points-container"></div>
            </div>
        </div>
        <div class="control-group">
            <h3>路径规划</h3>
            <div class="list-panel" id="planning-waypoints-list">
                <h4>规划列表 (起点->途经点->终点)</h4>
                <div id="planning-waypoints-container"></div>
            </div>
            <select id="strategy-selector">
                <option value="LEAST_TIME">时间最短</option>
                <option value="LEAST_DISTANCE">距离最短</option>
                <option value="LEAST_FEE">费用最少</option>
        <option value="AVOID_HIGHWAY">不走高速</option>
            </select>
            <button id="optimize-btn">开始顺路规划</button>
        </div>
        <div id="route-info-panel">
             <p><strong>预计时间：</strong><span id="route-time">--</span></p>
             <p><strong>总路程：</strong><span id="route-distance">--</span></p>
        </div>
        <button id="clear-btn" style="margin-top: 15px;">清空所有</button>
        <div id="error-message" class="error-message"></div>
    </div>

    <script type="text/javascript">
        window._AMapSecurityConfig = { securityJsCode: '18f3474d5a34085469b83c202da831ef' };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=02cd41675942a0db9428d859a0e6f4f3&plugin=AMap.Driving,AMap.Geolocation"></script>
    
    <script type="text/javascript">
        var map = new AMap.Map('container', { zoom: 11, center: [116.397428, 39.90923] });
        
        // --- 数据状态管理 ---
        var importedPoints = []; // 存放从CSV导入的所有点 {id, lng, lat, marker}
        var planningWaypoints = []; // 存放用户选择用于规划的点 {id, lng, lat}
        var driving = null;

        // --- DOM元素获取 ---
        var controlPanel = document.getElementById('control-panel'), menuToggle = document.getElementById('menu-toggle');
        var optimizeBtn = document.getElementById('optimize-btn'), clearBtn = document.getElementById('clear-btn');
        var errorMessage = document.getElementById('error-message');
        var strategySelector = document.getElementById('strategy-selector');
        var routeInfoPanel = document.getElementById('route-info-panel'), routeTimeEl = document.getElementById('route-time'), routeDistanceEl = document.getElementById('route-distance');
        var importCsvBtn = document.getElementById('import-csv-btn'), csvInput = document.getElementById('csv-input');
        var importedPointsContainer = document.getElementById('imported-points-container');
        var planningWaypointsContainer = document.getElementById('planning-waypoints-container');

        // --- Marker 样式定义 ---
        var defaultIcon = new AMap.Icon({
            size: new AMap.Size(25, 34),
            image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
            imageSize: new AMap.Size(25, 34)
        });
        var selectedIcon = new AMap.Icon({
            size: new AMap.Size(25, 34),
            image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
            imageSize: new AMap.Size(25, 34)
        });

        // --- 事件绑定 ---
        menuToggle.addEventListener('click', function(e) { e.stopPropagation(); controlPanel.classList.toggle('collapsed'); });
        map.on('click', function() { if (!controlPanel.classList.contains('collapsed')) { controlPanel.classList.add('collapsed'); } });
        controlPanel.addEventListener('click', function(e) { e.stopPropagation(); });
        optimizeBtn.addEventListener('click', doPathOptimize);
        clearBtn.addEventListener('click', clearAll);
        importCsvBtn.addEventListener('click', function() { csvInput.click(); });
        csvInput.addEventListener('change', handleFileSelect);

        if (window.innerWidth > 768) { controlPanel.classList.remove('collapsed'); }
        
        // --- 主要功能函数 ---
        
        function handleFileSelect(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCsvAndRender(e.target.result);
                } catch (err) {
                    showErrorMessage('解析文件失败：' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCsvAndRender(csvText) {
            clearAll();
            var lines = csvText.trim().split(/\r\n|\n/);
            var tempPoints = [];
            
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                var parts = line.split(',');
                if (parts.length < 3) continue;

                var id = parts[0].trim();
                var lng = parseFloat(parts[1]);
                var lat = parseFloat(parts[2]);

                if (!id || isNaN(lng) || isNaN(lat)) continue;
                tempPoints.push({ id: id, lng: lng, lat: lat });
            }

            if (tempPoints.length === 0) {
                showErrorMessage('未找到有效坐标点');
                return;
            }

            importedPoints = tempPoints;
            renderImportedPoints();
            map.setFitView();
            showErrorMessage('成功导入 ' + importedPoints.length + ' 个点！');
        }
        
        function renderImportedPoints() {
            importedPointsContainer.innerHTML = '';
            importedPoints.forEach(function(point, index) {
                // 创建Marker
                var marker = new AMap.Marker({
                    position: [point.lng, point.lat],
                    icon: defaultIcon,
                    label: { content: String(point.id), direction: 'bottom' },
                    extData: { id: point.id } // 把ID存入marker
                });
                point.marker = marker; // 将marker关联回数据点
                marker.on('click', function() {
                    togglePointInPlan(point);
                });
                map.add(marker);

                // 创建列表项
                var item = document.createElement('div');
                item.className = 'list-item';
                item.textContent = 'ID: ' + point.id;
                item.onclick = function() {
                    togglePointInPlan(point);
                };
                importedPointsContainer.appendChild(item);
                point.listItem = item; // 关联列表项
            });
        }

        function togglePointInPlan(point) {
            var existingIndex = planningWaypoints.findIndex(p => p.id === point.id);

            if (existingIndex > -1) {
                // 如果已在规划中，则移除
                planningWaypoints.splice(existingIndex, 1);
                point.marker.setIcon(defaultIcon); // 恢复默认图标
                point.listItem.classList.remove('selected');
            } else {
                // 如果不在规划中，则添加
                planningWaypoints.push(point);
                point.marker.setIcon(selectedIcon); // 设置为选中图标
                point.listItem.classList.add('selected');
            }
            updatePlanningList();
        }

        function updatePlanningList() {
            planningWaypointsContainer.innerHTML = '';
            planningWaypoints.forEach(function(point, index) {
                var item = document.createElement('div');
                item.className = 'list-item';
                var label = (index === 0) ? '起点: ' : (index === planningWaypoints.length - 1) ? '终点: ' : '途经点: ';
                item.textContent = label + 'ID ' + point.id;
                
                var deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '移除';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation(); // 防止触发父元素的点击事件
                    togglePointInPlan(point);
                };

                item.appendChild(deleteBtn);
                planningWaypointsContainer.appendChild(item);
            });
        }

        function doPathOptimize() {
            if (planningWaypoints.length < 2) { showErrorMessage('至少选择2个点进行规划'); return; }
            var selectedPolicy = AMap.DrivingPolicy[strategySelector.value];
            if (driving) { driving.clear(); }
            routeInfoPanel.style.display = 'none';
            var selectedPolicy = AMap.DrivingPolicy[strategySelector.value];
            driving = new AMap.Driving({ map: map, policy: selectedPolicy, autoFitView: true, extensions: 'all' });
            
            var startPoint = new AMap.LngLat(planningWaypoints[0].lng, planningWaypoints[0].lat);
            var endPoint = new AMap.LngLat(planningWaypoints[planningWaypoints.length - 1].lng, planningWaypoints[planningWaypoints.length - 1].lat);
            var intermediatePoints = [];
            if (planningWaypoints.length > 2) {
                for (var i = 1; i < planningWaypoints.length - 1; i++) {
                    intermediatePoints.push(new AMap.LngLat(planningWaypoints[i].lng, planningWaypoints[i].lat));
                }
            }
            
            var searchOptions = { viaReordering: true };
            if (intermediatePoints.length > 0) { searchOptions.waypoints = intermediatePoints; }
            
            driving.search(startPoint, endPoint, searchOptions, function(status, result) {
                if (status === 'complete' && result.routes && result.routes.length) {
                    var route = result.routes[0];
                    routeTimeEl.textContent = formatTime(route.time);
                    routeDistanceEl.textContent = (route.distance / 1000).toFixed(2) + " 公里";
                    routeInfoPanel.style.display = 'block';
                } else {
                    showErrorMessage('路径规划失败: ' + (result.info || '未知错误'));
                }
            });
        }
        
        function clearAll() {
            if (driving) { driving.clear(); }
            map.remove(importedPoints.map(p => p.marker)); // 清除所有marker
            importedPoints = [];
            planningWaypoints = [];
            importedPointsContainer.innerHTML = '';
            planningWaypointsContainer.innerHTML = '';
            errorMessage.textContent = '';
            routeInfoPanel.style.display = 'none';
        }
        
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            setTimeout(function() { errorMessage.textContent = ''; }, 5000);
        }

        function formatTime(seconds) { if (isNaN(seconds) || seconds < 0) return "--"; var hours = Math.floor(seconds / 3600); var minutes = Math.floor((seconds % 3600) / 60); var result = ""; if (hours > 0) result += hours + "小时"; if (minutes > 0 || hours === 0) result += minutes + "分钟"; return result || "小于1分钟"; }
        
        // 初始化
        updatePlanningList();
    </script>
</body>
</html>
